# Implement a application to decode source data that generated by CAN tools to results file

## Models
`Convertor`
It includes name, DataSource and some convert rules. 

`DataSource`
A general type of DataSource. It references a .dbc file, which contains the message and signal definitions. And it also includes the data source mapping settings. There are two types of DataSource: CommonCANDataSource and J1939DataSource.

`CommonCANDataSource`
- MappingSettings
    - message id: CAN message id
    - fields: A list of field settings. Each field setting includes:
        - name: signal name
        - start bit
        - length
        - byte order
        - value type
        - factor: The factor to scale the raw value
        - offset
        - unit

`J1939DataSource`
- MappingSettings
    - PGN: The parameter group number of the message
    - fields: A list of field settings. Each field setting includes:
        - name: signal name
        - start bit
        - length
        - byte order
        - value type
        - factor
        - offset
        - unit
- filter settings
    - source address filter: A list of source addresses to filter messages

`ConvertRule`
A general type of convert rule, and a rule has its own parameters. It should assign a result folder to store the generated results.

`PlotRule`
A convert rule to generate plots. The result is an image file. It uses matplotlib to generate the plot. The paramerters are:
- title: the plot title
- xAxis: the x axis data field name
    - binding: the data field name of specified `DataSource` to bind the x axis. It could also be a incremented index.
- yAxis: It could be single or multiple yAxis for a `PlotRule`.
    - binding: the data field name of specified `DataSource` to bind the y axis
- figureStyle: figsize, dpi. Default is (6.4, 4.8), 160
- gridStyle: linestyle, alpha. Default is "--", 0.5
- tickStyle: lablesize. Default is 8
- legendStyle: label, loc, fontsize. Default is "legend1", 1, 8

`DataListRule`
A convert rule to generate data lists. The result is a csv file. The parameters are:
- fields: A list of data fields to include in the data list
    - binding: the data field name of specified `DataSource` to include in the data list
- delimiter: the delimiter of the csv file. Default is ","
- includeHeader: whether to include the header in the csv file. Default is True

`ConvertProcess`
It includes a `Convertor`, and it accepts a data file, use `run` method to start the convert logic defined in `Convertor`. The convert logic could be cancelled while running.

`DataSourceFectchRule`
A fetch rule for data source file. It includes:
- File Type: Allowed xlsx, csv
- Message ID column Index: The column index of message id(PGN) in the source data file
- Message Data column Index: The column index of message data in the source data file. The data format should be hex string, e.g. "x| 0A 1B 2C 3D 4E 5F 6A 7B" or "0A 1B 2C 3D 4E 5F 6A 7B"
- Timestamp column Index: The column index of timestamp in the source data file

## About UI
Main
1. Convertor selection dropdown. Select a convertor. Actually, it selects a `Convertor`.
2. DataFile mapping selection dropdown. Select a data file mapping. Actually, it selects a `DataSourceFectchRule`.
3. Data source file upload field. Accept the source data file. 
4. Start button. Run the decode process.
5. Cancel button. Enable when the decode process is started, and click the button will stop the decode process.
6. Configuration. Guide user to a configuration page.

Configuration
It includes 3 parts: Manage Convertors, Manage Data File Mappings, Export and Import Configuration.

Manage Convertors
1. A list of convertors. Select a convertor to edit or delete.
2. Add button. Add a new convertor in a prompt window.
- Add/Edit Convertor Prompt Window
    1. Name field. The name of the convertor.
    2. DataSource editor. 
    3. Convert Rules editor.
    4. Convertor Result Folder field. The folder to store the results files generated by the convertor.
    5. Save button. Save the convertor.
- DataSource Editor
    1. DataSource Type dropdown. Select the type of DataSource: CommonCANDataSource or J1939DataSource.
    2. DBC file upload field. Accept the .dbc file.
    3. Mapping Settings editor. Edit the mapping settings according to the DataSource type. Activated when a .dbc file is uploaded.
- Mapping Settings Editor
    - CommonCANDataSource Mapping Settings Editor
        1. A list of message mappings. There is a delete button at right side of each record.
        2. There is a add button at the bottom of the list. After clicking it, display a new record for filling in the message id and fields. The new record contains a dropdown button for selecting existing message ids from the loaded DBC file and a multi-select dropdown for selecting existing signals from the selected message id.
    - J1939DataSource Mapping Settings Editor
        1. A list of PGN mappings. There is a delete button at right side of each record.
        2. There is a add button at the bottom of the list. After clicking it, display a new record for filling in the PGN and fields. The new record contains a dropdown button for selecting existing PGNs from the loaded DBC file and a multi-select dropdown for selecting existing signals from the selected PGN.
        3. Filter Settings editor. A input field for the source address filter. Split by comma for multiple values.
- Convert Rules Editor
    1. A list of convert rules. Select a convert rule to edit or delete.
    2. Add button. Add a new convert rule in a prompt window.
    - Add/Edit Convert Rule Prompt Window
        1. Convert Rule Type dropdown. Select the type of convert rule: PlotRule or DataListRule.
        2. Convert Rule Settings editor. Edit the convert rule settings according to the convert rule type.
        3. Save button. Save the convert rule.
    - Convert Rule Settings Editor
        - PlotRule Settings Editor
            1. Title field. The plot title.
            2. XAxis binding field. The data field name of specified `DataSource` to bind the x axis. It could also be a incremented index.
            3. YAxis bindings editor. Edit the y axis bindings.
            - YAxis Bindings Editor
                1. A list of y axis bindings. Select a y axis binding to edit or delete.
                2. Add button. Add a new y axis binding in a prompt window.
                - Add/Edit YAxis Binding Prompt Window
                    1. Binding field. The data field name of specified `DataSource` to bind the y axis.
                    2. Save button. Save the y axis binding.
            4. Figure Style editor. Edit the figure style settings.
            5. Grid Style editor. Edit the grid style settings.
            6. Tick Style editor. Edit the tick style settings.
            7. Legend Style editor. Edit the legend style settings.
        - DataListRule Settings Editor
            1. Fields editor. Edit the data fields to include in the data list.
            - Fields Editor
                1. A list of data fields. Select a data field to edit or delete.
                2. Add button. Add a new data field in a prompt window.
                - Add/Edit Data Field Prompt Window
                    1. Binding field. The data field name of specified `DataSource` to include in the data list.
                    2. Save button. Save the data field.
            2. Delimiter field. The delimiter of the csv file.
            3. Include Header toggle. Whether to include the header in the csv file.
Manage Data File Mappings
1. A list of data file mappings. Select a data file mapping to edit or delete.
2. Add button. Add a new data file mapping in a prompt window.
- Add/Edit Data File Mapping Prompt Window
    1. Name field. The name of the data file mapping.
    2. File Type dropdown. Allowed xlsx, csv
    3. Message ID column Index field. The column index of message id(PGN) in the source data file
    4. Message Data column Index field. The column index of message data in the source data file.
    5. Timestamp column Index field. The column index of timestamp in the source data file
    6. Save button. Save the data file mapping.

Export and Import Configuration
1. Import button. Import the configuration from a json file.
2. Export button. Export the configuration to a json file.

## Workflow
1. User configures Convertors and Data File Mappings in the Configuration page.
2. User selects a Convertor and a Data File Mapping in the Main page.
3. User uploads a source data file.
4. User clicks the Start button to start the convert process.
5. The system decodes the source data file according to the selected Convertor and Data File Mapping.
6. The system generates the results files in the specified result folder of each Convert Rule.

## Technology
Language: python
UI Framework: PySide6
Plotting Library: matplotlib
Data Processing Library: pandas
DBC Processing Library: cantools

## Reference
- DBC file sample: `./IMU400RI.dbc`